define(["jquery"],function(a){function e(){b?b.selectAll("*").remove():b=d3.select("#feedback_analysis").append("svg").attr("width","100%").attr("height","100%")}function f(a,b){return b.selectAll("text").data(a).enter().append("text").text(function(b){return b.text})}function g(a,b){var c=d3.quantile(b,.25),d=d3.quantile(b,.75),e=(d-c)*a,f=0,g=b.length-1;for(isNaN(d)&&(d=d3.median(b)),isNaN(c)&&(c=d3.median(b));b[f]<c-e;)f+=1;for(;b[g]>d+e;)g-=1;return[f,g]}function h(a){return a.map(function(a,b){return a.label&&a.label.length||(a.label=a.question),{text:a.label,xVal:0,yVal:b+1}})}function i(a,b){var c="/local/powertla/rest.php/content/survey/results/"+$.urlParam("id");$.ajax({url:c,type:"get",cache:!1,dataType:"json",error:function(){o(b)},success:function(c){"string"==typeof c&&(c=JSON.parse(c)),a(c),o(b)}})}function j(){i(l,j)}function k(){i(m,k)}function l(a){b.selectAll("*").remove(),c=null;var e,f=0,i=0,j=[],k=[],l=[],m={},n=[];for(e=0;e<a.length;e++)switch(a[e].typ){case"numeric":j.push(a[e])}for(e=0;e<j.length;e++)j[e].answers=j[e].answers.map(function(a){return+a}),n=j[e].answers.sort(function(a,b){return+a-+b}),m={text:j[e].question,median:d3.median(n),q1:d3.quantile(n,.25),q3:d3.quantile(n),ipr:g(1.5,n),y:e,data:n},isNaN(m.q3)&&(m.q3=m.median),isNaN(m.q1)&&(m.q1=m.median),m.q1===m.q3&&(m.q1=m.q1-1),k.push(d3.extent(j[e].answers)),l.push(m);f=d3.min(k.map(function(a){return a[0]})),i=d3.max(k.map(function(a){return a[1]}));var o={width:Math.floor($("#feedback_analysis").width()),height:Math.floor($("#feedback_analysis").height())},p=d3.scale.linear().domain([j.length+1,0]).range([50*j.length,0]),q=h(j),r=[f,0,i];$("#y-axis").length||b.append("g").attr("id","y-axis").attr("transform","translate(20,10)").selectAll("text").data(q).enter().append("text").text(function(b){return b.text}).attr("text-anchor","right").attr("y",function(a){return p(a.yVal)}).attr("dy","0.3ex");var s=d3.select("#y-axis").node().getBBox(),t=s.width+25;$("#feedback_analysis").height(Math.floor(s.height));var u=d3.scale.linear().domain([f-5,+i+5]).range([0,o.width-Math.floor(t)]);$("#x-axis").length||(d=b.append("g").attr("id","x-axis").attr("transform","translate( "+t+",10)"));var v=d.selectAll("text").data(r);v.enter().append("text").attr("text-anchor","middle").attr("x",function(a){return u(a)}).text(function(a){return a}),v.exit().remove(),$("#boxdata").length||(c=b.append("g").attr("id","boxdata").attr("transform","translate("+t+",10)")),c.selectAll("rect").data(l).enter().append("rect").attr("r",2).attr("class",function(){return"blue"}).attr("y",function(a){return p(a.y+1-.2)}).attr("x",function(a){return u(a.q1)}).attr("width",function(a){var b=a.q3;return isNaN(b)&&(b=a.median),u(b)-u(a.q1)}).attr("height",function(){return p(.4)});var w=c.selectAll("line").data(l);w.enter().append("line").attr("stroke","black").attr("stroke-width",1).attr("x1",function(a){return u(parseInt(a.data[a.ipr[0]]))}).attr("y1",function(a){return p(a.y+1)}).attr("x2",function(a){return u(parseInt(a.data[a.ipr[1]]))}).attr("y2",function(a){return p(a.y+1)}),w.exit().remove();var x=d.selectAll("line").data(r);x.enter().append("line").attr("stroke","grey").attr("stroke-dasharray","5, 5").attr("stroke-width",.75).attr("x1",function(a){return u(0)}).attr("y1",function(a){return p(.5)}).attr("x2",function(a){return u(0)}).attr("y2",function(a){return p(j.length+1)+20}),x.exit().remove()}function m(a){var d,e,g,i=[],j=[],k=10,l=0;for(d=0;d<a.length;d++)switch(a[d].typ){case"multichoicerated":case"multichoice":i.push(a[d])}var m=i[0].answerValues.map(function(a,b){return{xVal:b+1,yVal:0,text:Array.isArray(a)?a[1]:a}}),n=h(i);for(e=0;e<i.length;e++){var o=[],p={},q=parseInt(i[e].range_to);for(q>l&&(l=q),i[e].answers.length>k&&(k=i[e].answers.length),g=0;g<i[e].answerValues.length;g++){o.push(0);p[i[e].answerValues[g][0]]=g}for(d=0;d<i[e].answers.length;d++){var s=parseInt(i[e].answers[d]);if(s>0||0===s){o[p[s]]+=1}}for(d=0;d<o.length;d++)j.push({rVal:o[d],xVal:d+1,yVal:e+1})}var u=d3.scale.linear().domain([0,k]).range([0,30]),v=d3.scale.linear().domain([0,l+1]).range([0,75*(l+1)]),w=d3.scale.linear().domain([i.length+1,0]).range([75*i.length,0]);$("#y-axis").length||f(n,b.append("g").attr("id","y-axis").attr("transform","translate(20,10)")).attr("text-anchor","right").attr("y",function(a){return w(a.yVal)}).attr("dy","0.3ex");var x=d3.select("#y-axis").node().getBBox(),y=x.width;$("#feedback_analysis").height(Math.floor(x.height+50)),$("#x-axis").length||(f(m,b.append("g").attr("id","x-axis").attr("transform","translate( "+(y+10)+",15)")).attr("text-anchor","middle").attr("x",function(a){return v(a.xVal)}),c=b.append("g").attr("id","datamatrix").attr("transform","translate("+(y+10)+",10)"));var z=c.selectAll("circle").data(j);z.enter().append("circle"),z.attr("class",function(a){return"blue"}).attr("r",function(a){return u(a.rVal)}).attr("cx",function(a){return v(a.xVal)}).attr("cy",function(a){return w(a.yVal)}),z.exit().remove()}function n(){var a="/local/powertla/rest.php/content/survey/analysis/"+$.urlParam("id"),c={top:20,right:20,bottom:70,left:40},d=600-c.left-c.right,e=400-c.top-c.bottom,f=d3.scale.ordinal().rangeRoundBands([0,d],.05),g=d3.scale.linear().range([e,0]),h=d3.svg.axis().scale(f).orient("bottom"),i=d3.svg.axis().scale(g).orient("left").ticks(4),j=d3.select("#y-axis");$("#feedback_analysis").height(Math.floor(j.height)-600),d3.json(a,function(a,c){if(c){c.forEach(function(a){a.label=a.label,a.average_value=+a.average_value}),f.domain(c.map(function(a){return a.label})),g.domain([0,d3.max(c,function(a){return a.average_value})]),b.append("g").attr("id","x-axis").attr("class","x axis").attr("transform","translate(0,"+e+")").call(h).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.55em").attr("transform","rotate(-45)"),b.append("g").attr("id","y-axis").attr("class","y axis").call(i).append("text").attr("transform","rotate(-90)").attr("y",3).attr("dy",".21em").style("text-anchor","end"),b.selectAll("bar").data(c).enter().append("rect").attr("class","bar").attr("x",function(a){return f(a.label)}).attr("width",f.rangeBand()).attr("y",function(a){return g(a.average_value)}).attr("height",function(a){return e-g(a.average_value)});var d=d3.select("#y-axis").node().getBBox(),j=d3.select("#x-axis").node().getBBox(),k=d.height+j.height;$("#feedback_analysis").height(Math.floor(k))}o(n)})}function o(a){$("#fbanalysis_liveupdate").hasClass("btn-warning")&&setTimeout(a,3e3)}function p(){$("#fbanalysis_liveupdate").toggleClass("btn-warning"),$("#fbanalysis_liveupdate").toggleClass("btn-outline-warning"),$("#fbanalysis_barchart").hasClass("btn-primary")?o(n):$("#fbanalysis_bubblechart").hasClass("btn-primary")?o(k):$("#fbanalysis_boxchart").hasClass("btn-primary")&&o(j)}function q(a){"#fbanalysis_boxchart"!==a&&($("#fbanalysis_boxchart").removeClass("btn-primary"),$("#fbanalysis_boxchart").addClass("btn-outline-primary")),"#fbanalysis_barchart"!==a&&($("#fbanalysis_barchart").removeClass("btn-primary"),$("#fbanalysis_barchart").addClass("btn-outline-primary")),"#fbanalysis_bubblechart"!==a&&($("#fbanalysis_bubblechart").removeClass("btn-primary"),$("#fbanalysis_bubblechart").addClass("btn-outline-primary")),e()}function r(){$("#fbanalysis_boxchart").toggleClass("btn-primary"),$("#fbanalysis_boxchart").toggleClass("btn-outline-primary"),q("#fbanalysis_boxchart"),v("#fbanalysis_boxchart"),j()}function s(){$("#fbanalysis_barchart").toggleClass("btn-primary"),$("#fbanalysis_barchart").toggleClass("btn-outline-primary"),q("#fbanalysis_barchart"),v("#fbanalysis_barchart"),n()}function t(){$("#fbanalysis_bubblechart").toggleClass("btn-primary"),$("#fbanalysis_bubblechart").toggleClass("btn-outline-primary"),q("#fbanalysis_bubblechart"),v("#fbanalysis_bubblechart"),k()}function u(){$(".feedback_info:first-child").before('<div id="feedback_analysis" class="hidden">'),$("#feedback_analysis").before('<div id="feedback_vizbuttons" class="fbbuttons">'),$("#feedback_vizbuttons").append('<span id="fbanalysis_barchart" class="btn btn-outline-primary">Bar Chart</span>').append('<span id="fbanalysis_bubblechart" class="btn btn-outline-primary">Bubble Chart</span>').append('<span id="fbanalysis_boxchart" class="btn btn-outline-primary">Box Chart</span>').append('<span id="fbanalysis_liveupdate" class="btn btn-outline-warning">Live Update (beta)</span>'),$("#fbanalysis_barchart").click(s),$("#fbanalysis_boxchart").click(r),$("#fbanalysis_bubblechart").click(t),$("#fbanalysis_liveupdate").click(p)}function v(a){$(a).hasClass("btn-primary")?$("#feedback_analysis").removeClass("hidden"):$("#feedback_analysis").addClass("hidden")}function w(){var a=window.location.pathname.split("/"),b=a.pop();"feedback"===a.pop()&&"analysis.php"===b&&u()}var b,c,d;$.urlParam=function(a){var b=new RegExp("[?&]"+a+"=([^&#]*)").exec(window.location.href);return null===b?null:b[1]||0},console.log("l√§uft"),$(document).ready(w)});